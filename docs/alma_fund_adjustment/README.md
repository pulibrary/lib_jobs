# Alma Fund Adjustment
  This job moves Peoplesoft Transactions from Peoplesoft to Alma to keep the fund balances in Alma in sync with the fund balances in Peoplesoft.  These are any expeses not accounted for in Alma for material purchases like a book, or paying a UPS bill.

## Flow Diagrams


```mermaid
sequenceDiagram
    accTitle: Syncing Alma fund balances with Peoplesoft.
    accDescr {
      Peoplesoft Samba Share receives Fund Transaction csv file generated by Peoplesoft (2:30 princeton local time Daily).
      Lib Jobs requests list of fund transaction csv files from Peoplesoft Samba Share and receives it.
      Lib Jobs checks for duplicate Transaction in the local database table peoplesoft_transactions. If there is one, it sends Email to Student Accounts and PUL stakeholders. If the file is empty, the fund transaction csv files is renamed to .processed and sent to Peoplesoft Samba Share. Otherwise, all the new transactions are uploaded to lib-sftp.
      If there is an FTP error, it is logged. If not, the fund transaction csv files is renamed to .processed and sent to Peoplesoft Samba Share.
      Alma requests lib-sftp for the list of fund transactions csv file and receives it. This file is renamed to .handled.
      Alma processes the file to apply transactions to the funds, logging any errors.
    }
    Peoplesoft->>Peoplesoft Samba Share: generates Fund Transaction csv file (2:30 princeton local time Daily)
    Lib Jobs->>+Peoplesoft Samba Share: request list of fund transaction csv files
    Peoplesoft Samba Share-->>-Lib Jobs: list of fund transaction csv files
    Lib Jobs->>Lib Jobs: Check for duplicate Transaction in the local database table peoplesoft_transactions
    alt ANY duplicate transaction    
      Lib Jobs->>Email Server: Sends Email to Student Accounts and PUL stakeholders
    else Empty file
      Lib Jobs->>Peoplesoft Samba Share: rename fund transaction csv files .processed
    else All new transactions
      Lib Jobs->>lib-sftp: upload fund transaction csv files
      alt No FTP error
      Lib Jobs->>Peoplesoft Samba Share: rename fund transaction csv files .processed
      else
        Lib Jobs->>Lib Jobs: log error
      end
    end
    Alma->>+lib-sftp: requests list of fund transaction csv file
    lib-sftp-->>-Alma: returns a list of fund transaction csv file
    Alma->>lib-sftp: rename the file to .handled
    Alma->>Alma: Process file to apply the transactions to the funds
    Alma->>Alma: Any errors are logged
```
